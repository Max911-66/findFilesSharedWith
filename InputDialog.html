<!DOCTYPE html>
<html>
  <head>
    <title>Inserisci Parametri</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
      let pickerApiLoaded = false;
      let auth2Loaded = false;
      let oauthToken = null;
      let config = {};

      function onApiLoad() {
        google.script.run.withSuccessHandler((cfg) => {
            config = cfg;
            console.log("✅ Configurazione caricata:", config);
            
            gapi.load('auth2', function() {
                gapi.auth2.init({client_id: config.CLIENT_ID}).then(() => {
                    auth2Loaded = true;
                    console.log("✅ Google Auth2 caricato");
                    signInUser();
                }).catch(error => {
                    console.error("❌ Errore durante l'inizializzazione di Auth2:", error);
                });
            });
            
            gapi.load('picker', function() {
                pickerApiLoaded = true;
                console.log("✅ Google Picker API caricata");
            });
        }).getPickerConfig();
      }

      function signInUser() {
        if (!auth2Loaded) {
          console.warn("⚠ auth2 non è ancora caricato, riprovo tra 500ms...");
          setTimeout(signInUser, 500);
          return;
        }
        
        let authInstance = gapi.auth2.getAuthInstance();
        authInstance.signIn().then(user => {
            oauthToken = user.getAuthResponse().access_token;
            console.log("✅ Token OAuth ricevuto:", oauthToken);
        }).catch(error => {
            console.error("❌ Errore di autenticazione:", error);
        });
      }

      function openFolderPicker() {
        if (!pickerApiLoaded) {
          alert("⚠ Attendere il caricamento dell'API di Google Picker.");
          return;
        }
        if (!auth2Loaded || !oauthToken) {
          alert("⚠ Effettuare l'accesso prima di selezionare una cartella.");
          signInUser();
          return;
        }
        if (!config.DEVELOPER_KEY) {
          alert("⚠ La chiave API non è disponibile. Riprovare più tardi.");
          return;
        }

        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
          .setSelectFolderEnabled(true)
          .setIncludeFolders(true)
          .setMimeTypes("application/vnd.google-apps.folder");

        const picker = new google.picker.PickerBuilder()
          .setDeveloperKey(config.DEVELOPER_KEY)
          .setOAuthToken(oauthToken)
          .addView(view)
          .setCallback(folderSelected)
          .build();

        picker.setVisible(true);
      }

      function folderSelected(data) {
        if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
          const folder = data[google.picker.Response.DOCUMENTS][0];
          document.getElementById("folderUrl").value = folder.id;
          document.getElementById("folderName").innerText = "📁 Selezionato: " + folder.name;
        }
      }

      function saveAndRun() {
        const email = document.getElementById('email').value;
        const folderId = document.getElementById('folderUrl').value;

        if (!email || !folderId) {
          alert("⚠ Inserisci un'email e seleziona una cartella.");
          return;
        }

        google.script.run.saveParameters(email, folderId);
        google.script.run.getResultsPage(email, folderId);
      }

      function loadPreviousParameters() {
        google.script.run
          .withSuccessHandler((params) => {
            document.getElementById('email').value = params.email || '';
            document.getElementById('folderUrl').value = params.folderId || '';
          })
          .getParameters();
      }
    </script>
  </head>
  <body onload="onApiLoad(); loadPreviousParameters();">
    <h2>Inserisci Parametri</h2>
    <form>
      <label for="email">Email:</label><br>
      <input type="text" id="email" name="email" style="width: 100%;" placeholder="Inserisci email"><br><br>
      <label for="folderUrl">Cartella:</label><br>
      <button type="button" onclick="openFolderPicker()">📂 Seleziona Cartella</button>
      <span id="folderName" style="margin-left: 10px;"></span>
      <input type="hidden" id="folderUrl" name="folderUrl"><br><br>
      <button type="button" onclick="saveAndRun()">Salva e Avvia</button>
    </form>
  </body>
</html>