<!DOCTYPE html>
<html>
  <head>
    <title>Inserisci Parametri</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
      let pickerApiLoaded = false;
      let oauthToken = null;
      let config = {};

      function onApiLoad() {
        gapi.load('auth2', function() {
            gapi.auth2.init({client_id: config.CLIENT_ID});
        });
        
        gapi.load('picker', function() {
            pickerApiLoaded = true;
        });

        google.script.run.withSuccessHandler((cfg) => {
            config = cfg;
        }).getPickerConfig();
      }

      function onAuthApiLoad() {
        google.script.run
          .withSuccessHandler((token) => {
            oauthToken = token;
          })
          .getOAuthToken();
      }

      function openFolderPicker() {
        if (!pickerApiLoaded || !oauthToken || !config.DEVELOPER_KEY) {
          alert("âš  Attendere il caricamento dell'API o effettuare l'accesso.");
          return;
        }

        const view = new google.picker.DocsView(google.picker.ViewId.FOLDERS)
          .setSelectFolderEnabled(true)
          .setIncludeFolders(true)
          .setMimeTypes("application/vnd.google-apps.folder");

        const picker = new google.picker.PickerBuilder()
          .setDeveloperKey(config.DEVELOPER_KEY)
          .setOAuthToken(oauthToken)
          .addView(view)
          .setCallback(folderSelected)
          .build();

        picker.setVisible(true);
      }

      function folderSelected(data) {
        if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
          const folder = data[google.picker.Response.DOCUMENTS][0];
          document.getElementById("folderUrl").value = folder.id; // Salviamo solo l'ID
          document.getElementById("folderName").innerText = "ðŸ“ Selezionato: " + folder.name;
        }
      }

      function saveAndRun() {
        const email = document.getElementById('email').value;
        const folderId = document.getElementById('folderUrl').value;

        if (!email || !folderId) {
          alert("âš  Inserisci un'email e seleziona una cartella.");
          return;
        }

        google.script.run.saveParameters(email, folderId);
        google.script.run.getResultsPage(email, folderId);
      }

      function loadPreviousParameters() {
        google.script.run
          .withSuccessHandler((params) => {
            document.getElementById('email').value = params.email || '';
            document.getElementById('folderUrl').value = params.folderId || '';
          })
          .getParameters();
      }
    </script>
  </head>
  <body onload="onApiLoad(); loadPreviousParameters();">
    <h2>Inserisci Parametri</h2>
    <form>
      <label for="email">Email:</label><br>
      <input type="text" id="email" name="email" style="width: 100%;" placeholder="Inserisci email"><br><br>
      <label for="folderUrl">Cartella:</label><br>
      <button type="button" onclick="openFolderPicker()">ðŸ“‚ Seleziona Cartella</button>
      <span id="folderName" style="margin-left: 10px;"></span>
      <input type="hidden" id="folderUrl" name="folderUrl"><br><br>
      <button type="button" onclick="saveAndRun()">Salva e Avvia</button>
    </form>
  </body>
</html>
